<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasks | Ads Watch</title>
  <!-- Tailwind CSS CDN for a clean, modern, and responsive design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for a modern font (Inter) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Toastify for beautiful toast messages -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      color: #374151;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
    }
    .container-custom {
      max-width: 600px;
      width: 100%;
      background: #ffffff;
      padding: 2rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .status-info {
      background-color: #e0f2fe; /* Light blue background */
      border-radius: 0.75rem;
      border: 1px solid #93c5fd; /* Light blue border */
    }
    video {
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .btn {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .btn-start {
      background: linear-gradient(to right, #3b82f6, #2563eb); /* Blue gradient */
    }
    .btn-start:hover {
      background: linear-gradient(to right, #2563eb, #1d4ed8);
    }
    .btn-submit {
      background: linear-gradient(to right, #10b981, #059669); /* Green gradient */
    }
    .btn-submit:hover {
      background: linear-gradient(to right, #059669, #047857);
    }
    .btn[disabled] {
      background-color: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }
    .toastify.success {
      background-color: #10b981;
    }
    .toastify.error {
      background-color: #ef4444;
    }
    /* New styles for info modal */
    .info-icon {
        position: absolute;
        top: 2rem;
        right: 2rem;
        color: #1e3a8a;
        cursor: pointer;
        font-size: 1.5rem;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s ease-in-out;
    }
    .modal-content {
        background-color: #ffffff;
        margin: 10vh auto;
        padding: 2rem;
        border-radius: 1.5rem;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .close-btn {
        color: #9ca3af;
        float: right;
        font-size: 2rem;
        font-weight: bold;
        transition: color 0.2s;
    }
    .close-btn:hover, .close-btn:focus {
        color: #1f2937;
        text-decoration: none;
        cursor: pointer;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideIn {
        from { transform: scale(0.95) translateY(20px); opacity: 0; }
        to { transform: scale(1) translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container-custom relative">
    <i class="fas fa-info-circle info-icon" id="infoIcon"></i>
    <h2 class="text-3xl font-bold text-center mb-6 text-gray-800"><i class="fas fa-play-circle text-blue-600 mr-2"></i> My Daily Ads</h2>

    <div id="statusInfo" class="status-info p-4 text-center text-sm font-medium mb-6 rounded-xl" style="display: none;">
      <p class="text-gray-600">Total Ads: <span id="totalAds" class="text-blue-700 font-bold">...</span></p>
      <p class="text-gray-600 mt-1">Watched Today: <span id="adsWatched" class="text-blue-700 font-bold">...</span></p>
      <p class="text-gray-600 mt-1">Remaining: <span id="adsRemaining" class="text-blue-700 font-bold">...</span></p>
    </div>

    <div id="taskSection" class="relative" style="display: none;">
      <video id="adVideo" preload="auto" class="mt-6"></video>
      <button id="actionBtn" class="btn btn-start text-white py-3 px-6 rounded-lg w-full font-semibold mt-6">
        <i class="fas fa-play mr-2"></i> Start
      </button>
    </div>

    <div id="noPackageMsg" class="p-4 rounded-xl text-center font-bold text-red-600 bg-red-100 mt-6" style="display: none;">
      ‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡ßá‡¶á‡•§ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶ï‡¶ø‡¶®‡ßÅ‡¶®‡•§
    </div>

    <div id="noTasksMsg" class="p-4 rounded-xl text-center font-bold text-green-700 bg-green-100 mt-6" style="display: none;">
      üéâ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶®!
    </div>
  </div>

  <!-- Info Modal HTML -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3 class="text-xl font-bold mb-4 text-gray-800">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá?</h3>
      <p class="text-gray-600 text-sm leading-relaxed">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶π‡¶≤ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶ï ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø 'Start' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá 'Submit' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡ß®‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡•§ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶è‡¶° ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶è‡¶° ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶¶‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡¶®‡¶æ‡•§ </p>
    </div>
  </div>

  <script>
    // --- Do not change this line, this is the original logic from the user's code ---
    const token = localStorage.getItem('token');
    const adVideo = document.getElementById('adVideo');
    const actionBtn = document.getElementById('actionBtn');
    const statusInfo = document.getElementById('statusInfo');
    const noPackageMsg = document.getElementById('noPackageMsg');
    const noTasksMsg = document.getElementById('noTasksMsg');
    const totalAdsElem = document.getElementById('totalAds');
    const adsWatchedElem = document.getElementById('adsWatched');
    const adsRemainingElem = document.getElementById('adsRemaining');

    // ‚úÖ Place your ad video URLs here
    const adVideoUrls = [
 "https://ik.imagekit.io/ubdzcqpss/SSYouTube.online_Grant%20ROI%2010%20second%20TV%20Ad_1080p.mp4?updatedAt=1755070213649",
       "https://ik.imagekit.io/ubdzcqpss/SSYouTube.online_Easy%20Commercial%2010%20Seconds%20Free%20Offer%20TaxSlayer.com_720p.mp4?updatedAt=1755070545140",
      "https://ik.imagekit.io/ubdzcqpss/ixigo%20tvc%20(TV%20commercial)%20-%2010%20sec.mp4?updatedAt=1755071175823",
      "https://ik.imagekit.io/ubdzcqpss/videoplayback.mp4?updatedAt=1755071174605",
      "https://ik.imagekit.io/ubdzcqpss/Ads%20folder/Air%20Asia%20-%20Billboard%20-%20Animation%20-%2010%20seconds%20_%20animated%20advertisement%20commercials.mp4?updatedAt=1755071906848",
      "https://ik.imagekit.io/ubdzcqpss/Ads%20folder/OnTheMarket%20-%2010%20second%20TV%20advert%202024(1).mp4?updatedAt=1755071905353",
    ];
    let currentAdIndex = 0;

    // Function to show a toast message
    function showToast(message, type = 'success') {
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: type === 'success' ? '#10b981' : '#ef4444',
        stopOnFocus: true,
        close: true,
        className: type,
      }).showToast();
    }

    async function loadTaskStatus() {
      if (!token) {
        window.location.href = '/login';
        return;
      }
      try {
        const res = await fetch('/api/tasks/status', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();

        if (data.success) {
          if (data.hasPackage) {
            statusInfo.style.display = 'block';
            totalAdsElem.innerText = data.adsLimit;
            adsWatchedElem.innerText = data.adsWatched;
            adsRemainingElem.innerText = data.adsLimit - data.adsWatched;

            if (data.adsWatched < data.adsLimit) {
              document.getElementById('taskSection').style.display = 'block';
              loadRandomAd();
            } else {
              noTasksMsg.style.display = 'block';
            }
          } else {
            noPackageMsg.style.display = 'block';
          }
        } else {
          showToast(data.message || 'Error fetching task status.', 'error');
        }
      } catch (err) {
        console.error("Error:", err);
        showToast('Server error. Please try again.', 'error');
      }
    }

    function loadRandomAd() {
      currentAdIndex = Math.floor(Math.random() * adVideoUrls.length);
      adVideo.src = adVideoUrls[currentAdIndex];
      actionBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Start';
      actionBtn.className = 'btn btn-start text-white py-3 px-6 rounded-lg w-full font-semibold mt-6';
      actionBtn.disabled = false;
    }

    actionBtn.addEventListener('click', () => {
      if (actionBtn.querySelector('i').classList.contains('fa-play')) {
        adVideo.play();
        actionBtn.disabled = true;
        
        adVideo.onended = () => {
            actionBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Submit';
            actionBtn.className = 'btn btn-submit text-white py-3 px-6 rounded-lg w-full font-semibold mt-6';
            actionBtn.disabled = false;
        };
      } else if (actionBtn.querySelector('i').classList.contains('fa-check')) {
        submitTask();
      }
    });

    async function submitTask() {
      actionBtn.disabled = true;
      try {
        const res = await fetch('/api/tasks/complete', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        if (res.ok) {
          showToast('‚úÖ Ad watched successfully! Balance updated.', 'success');
          loadTaskStatus();
        } else {
          showToast(data.message || "Something went wrong!", 'error');
        }
      } catch (err) {
        console.error("Submit error:", err);
        showToast("Server error. Could not submit task.", 'error');
      }
    }

    loadTaskStatus();

    // JavaScript for the info modal
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById("infoModal");
      const infoIcon = document.getElementById("infoIcon");
      const closeBtn = document.getElementsByClassName("close-btn")[0];

      infoIcon.onclick = function() {
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
      }

      closeBtn.onclick = function() {
        modal.style.display = "none";
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
    });
  </script>
</body>
</html>